# flash-git
>Instruction and scripts for creating git-repositories on flash-drives and it's automatic mount-pull-push-unmount.

Данный инструмент предназначен для
- обеспечения хранения репозитория на флэшке;
- синхронизации репозиториев на разных компьютерах через флэшку путём простой вставки-и-вынимания флэшки;
- восстановления флэшки-носителя с локальной реплики репозитория на любом из компьютеров.

Флэшка-носитель может быть только одна - нельзя сделать резервную копию.

Данный инструмент не работает на операционных ситемах MS DOS, MS Windows, Колибри и Menuet.

# Создание флэшки-носителя

После того, как склонировали данный репозиторий (flash-git), создайте текстовый файл (например, *my-repositories*) и впишите туда пути к тем репозиториям, которые хотите хранить на флэшке.
```
/home/user/some_dir/00309_test_git_1
/home/user/some_dir/00309_test_git_2
```
Это должны быть проинициализированные git-репозитории. Наличие у них *origin* не имеет значения **, но знайте, что с момента инициализации флэшки-носителя все "git push" будут уходить не туда, куда уходили раньше, а на флэшку** .

Вставьте флэшку. Не монтируйте её. Посмотрите, в какой файл устройства отобразилась ваша флэшка (в данном случае, "sdb"):
```bash
$ dmesg | tail
[140914.594706] scsi host6: usb-storage 1-1.1.4:1.0
[140915.885470] scsi 6:0:0:0: Direct-Access     UFD 2.0  Silicon-Power4G  1100 PQ: 0 ANSI: 4
[140915.887133] sd 6:0:0:0: Attached scsi generic sg1 type 0
[140915.893635] sd 6:0:0:0: [sdb] 7864320 512-byte logical blocks: (4.03 GB/3.75 GiB)
[140915.894374] sd 6:0:0:0: [sdb] Write Protect is off
[140915.894381] sd 6:0:0:0: [sdb] Mode Sense: 43 00 00 00
[140915.895122] sd 6:0:0:0: [sdb] No Caching mode page found
[140915.895137] sd 6:0:0:0: [sdb] Assuming drive cache: write through
[140915.900535]  sdb:
[140915.904123] sd 6:0:0:0: [sdb] Attached SCSI removable disk
```
От имени root-а запустите скрипт install.sh, указав при этом путь до устройства флэшки ("/dev/sdb"):
> При первой инициализации флэшка будет отформатирована. Все данные на ней будут уничтожены!
```bash
# sudo ./install.sh /dev/sdb my-repositories
```
Во время первой инициализации на флэшке сохраняется список путей до репозиториев, указанных в my-repositories, а также *hostid* компьютера, на котором запускалась инициализация.
Если после первой инициализации та же флэшка будет инициализироваться на другом компьютере, то файл my-repositories не потребуется - список путей к репозиториям един между компьютерами.
Однако если будет указан my-repositories, то инициализация всех компов слетит и будет замещена новой инициализацией.

Во время исполнения скрипта *install.sh*:
В системе будет сохранена информация о флэшке: производитель, модель и серийный номер. Вдальнейшем, при подключении этой флэшки автоматически будут производиться следующие действия:
* флэшка монтируется
* со всех репозиториев (зарегистрированных в my-repositories), со всех веток делаются копии с префиксом "flash-git__XX__", где XX - идентификатор хоста (hostid). В каждой из тех веток делается "git pull" и "git push" на флэшку.
* флэшка размонтируется.

-------------

${underline}Инициализация флешки по локальным репозиториям:${nounderline}

* У локальных репозиториев прописывается флешка как дополнительный удалённый репозиторий, куда/откуда могут делаться делается push/pull (если эти репозитории были откуда-то стянуты, их origin остаётся на месте - все pull-push будут успешно проходить по-умолчанию туда, куда раньше проходили)
* В системе прописывается udev-правило на подключение КОНКРЕТНО ЭТОЙ флешки, что при её физическом подключении происходит
   * её автоматическое монтирование;
   * для всех указанных при инициализации репозиториев выполняется git pull;git push на флешку (см. более подробное описание этой процедуры ниже);
   * размонтирование флешки.
* На флешку записываются
   * список путей до локальных репозиториев, подлежащих синхронизации через эту флешку
   * Расшаренные клоны локальных репозиториев, на которые теперь можно делать pull/push
   * Уникальный идентификатор хоста - это для идентификации системой попытки повторно проинициализировать флешку

Порядок инициализации:
* составьте файл со списком путей до локальных репозиториев. Обозначим путь до этого файла как <путь_A>
* вставьте флешку (не монтируйте), определите файл её устройства (что-то вроде /dev/sdb)
* запустите от имени суперпользователя данный скрипт со следующими аргументами:

\$sudo ./flash-git.git --device=<ПУТЬ_ДО_УСТРОЙСТВА_ФЛЕШКИ> --repo-list=<путь_А>

${underline}Инициализация локальных репозиториев по флешке:${nounderline}

* По списку путей, записанных на флешку при инициализации флешки, клонируются с флешки репозитории (если по какому-то из этих путей директория уже есть на вашем компьютере, программа инициализации завершится, оповестив вас о невозможности инициализации репозиториев на вашем компьютере)
* В системе прописывается udev-правило на подключение КОНКРЕТНО ЭТОЙ флешки, что при её физическом подключении происходит
   * её автоматическое монтирование;
   * для всех указанных при инициализации репозиториев выполняется git pull;git push на флешку (см. более подробное описание этой процедуры ниже);
   * размонтирование флешки.
* На флешку записывается уникальный идентификатор хоста - это для идентификации системой попытки повторно проинициализировать репозитории по флешке

При клонировании репозиториев с флешки, при создании директорий для клонирования
все пути /home/*/... заменяются на /home/<ИМЯ_ПОЛЬЗОВАТЕЛЯ>/...

Порядок инициализации:
* вставьте флешку (не монтируйте), определите файл её устройства (что-то вроде /dev/sdb)
* запустите от имени суперпользователя данный скрипт со следующими аргументами:

\$sudo ./flash-git.git --device=<ПУТЬ_ДО_УСТРОЙСТВА_ФЛЕШКИ> --user=\$USER --group=\$USER
